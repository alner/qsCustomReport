define(["jquery","underscore","qlik","qvangular","ng!$q","ng!$http","./properties","./initialproperties","client.utils/state","./lib/js/extensionUtils","./lib/external/Sortable/Sortable","text!./lib/css/style.css","text!./lib/partials/customreport.ng.html"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){"use strict";return j.addStyleToHeader(l),{definition:g,initialProperties:h,support:{snapshot:!0,"export":!1,exportData:!0},resize:function(a,b){this.$scope.size.clientHeight=a[0].clientHeight,this.$scope.size.clientWidth=a[0].clientWidth,this.$scope.handleResize(a,b.props.allowCollapse)},paint:function(a,b){const d=this;return d.$scope.size.clientHeight=a[0].clientHeight,d.$scope.size.clientWidth=a[0].clientWidth,d.$scope.handleResize(a,b.props.allowCollapse),d.$scope.isInitialized()?void d.$scope.deserializeReport().then(function(){return d.$scope.showLimits(),c.Promise.resolve()}):c.Promise.resolve()},getExportRawDataOptions:function(c,e){var f=a("#cl-customreport-container"+e.id);e.getVisualization().then(function(){f.scope().collapsed||c.addItem(f.scope().fieldsAndSortbarVisible?{translation:"AppOverview.Expand",tid:"Expand",icon:"icon-maximize",select:function(){f.parents(".qv-inner-object").css("overflow","visible"),f.scope().hideFieldAndSortbar()}}:{translation:"AppOverview.Collapse",tid:"Collapse",icon:"icon-minimize",select:function(){f.parents(".qv-inner-object").css("overflow","hidden"),f.scope().showFieldAndSortbar()}});var a=b.countBy(f.scope().report.usedDimensionsAndMeasures,"type"),e=a.dimension?f.scope().report.dimensions.length-a.dimension:f.scope().report.dimensions.length,g=a.measure?f.scope().report.measures.length-a.measure:f.scope().report.measures.length;if(e||g){var h=c.addItem({translation:"properties.add",tid:"add-submenu",icon:"icon-add"});if(e){var i=h.addItem({translation:"Visualization.Requirements.AddDimension",tid:"add-dimension-submenu",icon:"icon-add"});b.each(f.scope().report.dimensions,function(a){a.selected||i.addItem({translation:a.title,tid:"dimension",select:function(){f.scope().selectItem(a)}})})}if(g){var j=h.addItem({translation:"Visualization.Requirements.AddMeasure",tid:"add-measure-submenu",icon:"icon-add"});b.each(f.scope().report.measures,function(a){a.selected||j.addItem({translation:a.title,tid:"switch",select:function(){f.scope().selectItem(a)}})})}}if(a.dimension||a.measure){var k=c.addItem({translation:"Common.Delete",tid:"remove-submenu",icon:"icon-remove"});if(a.dimension){var l=k.addItem({translation:"Common.Dimension",tid:"remove-dimension-submenu",icon:"icon-remove"});b.each(f.scope().report.dimensions,function(a){a.selected&&l.addItem({translation:a.title,tid:"dimension",select:function(){f.scope().removeItem(a)}})})}if(a.measure){var m=k.addItem({translation:"Common.Measure",tid:"remove-measure-submenu",icon:"icon-remove"});b.each(f.scope().report.measures,function(a){a.selected&&m.addItem({translation:a.title,tid:"switch",select:function(){f.scope().removeItem(a)}})})}}var n=f.scope().data.masterObjectList;if(n.length>1){var o=c.addItem({translation:"library.Visualizations",tid:"switch-submenu",icon:"icon-cogwheel"});b.each(f.scope().data.masterObjectList,function(a){a.qInfo.qId!=f.scope().data.activeTable.qInfo.qId&&o.addItem({translation:a.qMeta.title,tid:"switch",icon:"icon-table",select:function(){f.scope().data.activeTable=a,f.scope().changeTable()}})})}c.addItem({translation:"contextMenu.export",tid:"export",icon:"icon-toolbar-sharelist",select:function(){f.scope().exportData("exportToExcel")}});var p=f.scope().clickEvent;if(p){var q=d.getService("qvContextMenu");q.show(c,{position:{x:p.pageX,y:p.pageY}})}})},template:m,controller:["$scope",function(d){function f(){var a=e.defer();return m.createGenericObject({qInfo:{qType:"MasterObject"},qAppObjectListDef:{qType:"masterobject",qData:{name:"/metadata/name",visualization:"/visualization",title:"/title",labelExpression:"/labelExpression",tags:"/metadata/tags"}}}).then(function(c){var e=c.layout;d.data.masterObjectList=b.reduce(e.qAppObjectList.qItems,function(a,c){return"All tables"==d.data.tag?a.push(c):c.qMeta&&b.each(c.qMeta.tags,function(b){b==d.data.tag&&a.push(c)}),a},[]),d.isShowMasterObjectList=d.data.masterObjectList.length>1,!d.data.activeTable&&d.data.masterObjectList.length>0&&(d.data.activeTable=d.data.masterObjectList[0]),m.destroySessionObject(c.id),a.resolve(!0)}),a.promise}function g(){m.getList("MeasureList",function(a){d.data.masterMeasures=a.qMeasureList}),m.getList("DimensionList",function(a){d.data.masterDimensions=a.qDimensionList})}function h(){var a=e.defer(),c=b.reduce(d.report.usedDimensionsAndMeasures,function(a,b){return"dimension"==b.type&&(b.columnOptions.dataId=b.dataId,a.push(b.columnOptions)),a},[]),f=b.reduce(d.report.usedDimensionsAndMeasures,function(a,b){return"measure"==b.type&&(b.columnOptions.dataId=b.dataId,a.push(b.columnOptions)),a},[]),g=[],h=0,i=0;b.each(d.report.usedDimensionsAndMeasures,function(a){"measure"==a.type?(g.push(c.length+h),h+=1):(g.push(i),i+=1)});for(var j=[],k=0;k<d.report.usedDimensionsAndMeasures.length;k++)j.push(-1);return d.getInterColumnSortOrder().then(function(b){a.resolve({dimensions:c,measures:f,columnOrder:g,columnWidths:j,qInterColumnSortOrder:b&&b.qInterColumnSortOrder,interColumnSortOrder:b&&b.interColumnSortOrder,qNoOfLeftDims:b&&b.NoOfLeftDims||d.report.NoOfLeftDims||c.length})}),a.promise}d.customReportId=d.layout.qInfo.qId,d.size={clientHeight:-1,clientWidth:-1},d.fieldsAndSortbarVisible=!0,d.collapsed=!1,d.minWidthCollapsed=200,d.minHeightCollapsed=200,d.isShouldCommitChanges=!1,d.data={tag:null,tagColor:!0,sortOrder:"SortByA",activeTable:null,displayText:"Custom Report",vizualizationsLabel:d.layout.props.visualizationsLabel,dimensionsLabel:d.layout.props.dimensionsLabel,measuresLabel:d.layout.props.measuresLabel,masterObjectList:[],masterDimensions:null,masterMeasures:null,user:""};var j=c.currApp().model.layout.permissions;d.isUpdateRights=j&&j.update,d.isShowMasterObjectList=!1,d.report={title:null,visual:null,visualizationType:null,usedDimensionsAndMeasures:[],layout:null,dimensions:[],measures:[],interColumnSortOrder:[],columnOrder:[],NoOfLeftDims:null,currentState:null,limits:{dimensions:0,measures:0},selections:{dimension:0,measure:0}};var l=function(a){a.preventDefault(),a.stopPropagation()};d.reportConfig={group:{name:"report",put:["dim","measure"]},animation:150,ghostClass:"ghost",onStart:function(){a("body").on("dragstart",".qv-panel-wrap",l),a("body").on("dragover",".qv-panel-wrap",l)},onEnd:function(){a("body").off("dragstart",".qv-panel-wrap",l),a("body").off("dragover",".qv-panel-wrap",l)},onSort:function(a){d.report.usedDimensionsAndMeasures.splice(a.newIndex,0,d.report.usedDimensionsAndMeasures.splice(a.oldIndex,1)[0]),d.createChart()}},d.onClick=function(a){d.clickEvent=a},d.isInitialized=function(){};var m=c.currApp(),n=d.$parent.layout.qExtendsId?d.$parent.layout.qExtendsId:d.$parent.layout.qInfo.qId;d.handleResize=function(a,b){a[0].clientHeight<d.minHeightCollapsed||a[0].clientWidth<d.minWidthCollapsed?!d.collapsed&&b&&(d.collapsed=!0,d.createChart()):d.collapsed&&(d.collapsed=!1,d.createChart())},d.getClass=function(){return i.isInAnalysisMode()?"":"no-interactions"},d.getDimensionsProps=function(a,c){return b.map(a.dimensionInfos,function(d){var e=b.find(a.dimensionDefs,function(a){return a.qDef.cId==d.cId}),f=e;return e.qLibraryId&&(f.qType="dimension"),{title:d.qFallbackTitle||(e.qDef&&""==e.qDef.qFieldLabels[0]?e.qDef.qFieldDefs[0]:e.qDef.qFieldLabels[0]),description:"",columnOptions:f,type:"dimension",selected:c?!0:!1,dataId:e.qLibraryId||e.qDef.cId}})},d.getMeasuresProps=function(a,c){return b.map(a.measureInfos,function(d){var e=b.find(a.measureDefs,function(a){return a.qDef.cId==d.cId}),f=e;return e.qLibraryId&&(f.qType="measure"),{title:d.qFallbackTitle||(e.qDef&&e.qDef.qLabel?e.qDef.qLabel:e.qDef.qDef),description:"",columnOptions:f,type:"measure",selected:c?!0:!1,dataId:e.qLibraryId||e.qDef.cId}})},d.applyDimensionsAndMeasures=function(a,c){d.report.dimensions="SortByA"==d.data.sortOrder?b.sortBy(a,function(a){return a.title}):a,d.report.measures="SortByA"==d.data.sortOrder?b.sortBy(c,function(a){return a.title}):c},d.getDimensionsAndMeasuresFor=function(a){if(!a)return e.resolve();var b=e.defer();return m.getFullPropertyTree(a).then(function(a){a.getLayout().then(function(c){d.report.model=a,d.report.title=c.title,d.report.visualizationType=c.visualization;var e=[];e=e.concat(d.getDimensionsProps({dimensionInfos:c.qHyperCube.qDimensionInfo,dimensionDefs:a.propertyTree.qProperty.qHyperCubeDef.qDimensions}));var f=[];if(f=f.concat(d.getMeasuresProps({measureInfos:c.qHyperCube.qMeasureInfo,measureDefs:a.propertyTree.qProperty.qHyperCubeDef.qMeasures})),a.propertyTree.qProperty.qHyperCubeDef.qLayoutExclude&&a.propertyTree.qProperty.qHyperCubeDef.qLayoutExclude.qHyperCubeDef){var g=a.propertyTree.qProperty.qHyperCubeDef.qLayoutExclude.qHyperCubeDef;g.qCalcCond.qv="=false()",m.createCube(g).then(function(a){e=e.concat(d.getDimensionsProps({dimensionInfos:a.layout.qHyperCube.qDimensionInfo,dimensionDefs:g.qDimensions})),f=f.concat(d.getMeasuresProps({measureInfos:a.layout.qHyperCube.qMeasureInfo,measureDefs:g.qMeasures})),d.applyDimensionsAndMeasures(e,f),b.resolve(!0),m.destroySessionObject(a.id)})["catch"](function(){b.reject()})}else d.applyDimensionsAndMeasures(e,f),b.resolve(!0)})["catch"](function(){b.reject()})})["catch"](function(){b.reject()}),b.promise},d.loadActiveTable=function(){var a=e.defer();return null!==d.data.activeTable?setTimeout(function(){d.data.activeTable&&d.getDimensionsAndMeasuresFor(d.data.activeTable.qInfo.qId).then(function(){a.resolve(!0)})["catch"](function(){a.reject()})},500):a.resolve(!1),a.promise},d.showLimits=function(){var a=d.data.activeTable,c=a&&b.find(d.layout.props.constraints,function(b){return b.object===a.qInfo.qId});if(c){d.report.limits.dimensions=c.dimension,d.report.limits.measures=c.measure;var e=b.countBy(d.report.usedDimensionsAndMeasures,"type");d.report.selections.dimension=e.dimension||0,d.report.selections.measure=e.measure||0}else d.report.limits.dimensions=0,d.report.limits.measures=0},d.changeTable=function(){var a=e.defer();return d.data.activeTable&&(d.isShouldCommitChanges=!1,d.closeVisualization(),d.loadActiveTable().then(function(){d.deserializeReport({isLoadStateOnly:!0,qId:d.data.activeTable.qInfo.qId}).then(function(){a.resolve(!0),d.showLimits()})})),a.resolve(!0),a.promise},d.updateUsedDimensionsMeasures=function(a,b){var c=[];c=c.concat(d.getDimensionsProps({dimensionInfos:b.qDimensionInfo,dimensionDefs:a.qDimensions},!0)),c=c.concat(d.getMeasuresProps({measureInfos:b.qMeasureInfo,measureDefs:a.qMeasures},!0)),d.report.usedDimensionsAndMeasures=c},d.visualizationChanged=function(){var a=d.report.visual&&d.report.visual.model;if(a&&d.layout.props.variableExp===d.report.currentState){"pivot-table"===d.report.visualizationType&&(d.report.NoOfLeftDims=a.layout.qHyperCube.qNoOfLeftDims);var c=b.filter(b.keys(a.layout),function(a){return!a.match(/^q/)});d.report.layout=b.pick(a.layout,c),d.report.qInterColumnSortOrder=[],b.each(a.layout.qHyperCube.qEffectiveInterColumnSortOrder,function(a){d.report.qInterColumnSortOrder.push(a)}),d.getDimensionsAndMeasuresFor(d.data.activeTable&&d.data.activeTable.qInfo.qId).then(function(){a.effectiveProperties&&a.effectiveProperties.qHyperCubeDef?(d.updateUsedDimensionsMeasures(a.effectiveProperties.qHyperCubeDef,a.layout.qHyperCube),d.serializeReport()):a.getEffectiveProperties().then(function(b){d.report.visual&&d.report.visualizationType===b.visualization&&(d.updateUsedDimensionsMeasures(b.qHyperCubeDef,a.layout.qHyperCube),d.serializeReport())})})}},d.closeVisualization=function(){d.report.visual&&(d.report.visual.model.Validated.unbind(d.visualizationChanged),d.report.visual.close(),d.report.visual=null,d.report.visualScope=null)},d.createVisualization=function(){var c=e.defer();return d.closeVisualization(),h().then(function(e){if(d.report.visualizationType&&e.dimensions.length>0&&e.measures.length>0){var f={qDimensions:e.dimensions,qMeasures:e.measures,columnWidths:e.columnWidths};"table"===d.report.visualizationType&&e.columnOrder&&e.columnOrder.length>0&&(f.columnOrder=e.columnOrder),"pivot-table"!==d.report.visualizationType||isNaN(e.qNoOfLeftDims)||(f.qNoOfLeftDims=e.qNoOfLeftDims),e.qInterColumnSortOrder&&e.qInterColumnSortOrder.length>0&&(f.qInterColumnSortOrder=e.qInterColumnSortOrder);var g={};d.report.layout&&(g=b.extend(g,d.report.layout)),g.title=""==d.report.title?d.data.activeTable.qMeta.title:d.report.title,g.qHyperCubeDef=f,m.visualization.create(d.report.visualizationType,[],g).then(function(b){var e=(d.fieldsAndSortbarVisible?"customreporttable":"customreporttablezoomed")+d.customReportId;b.show(e),d.report.visual=b,d.report.visualScope=a("#"+e).find(".qv-object-content-container").scope(),d.report.visual.model.Validated.bind(d.visualizationChanged),c.resolve(!0)})}}),c.promise},d.prepareTable=function(b){var c=e.defer();return a("#cl-customreport-container"+d.customReportId+" .rain").show(),d.loadActiveTable().then(function(){b?(a("#cl-customreport-container"+d.customReportId+" .rain").hide(),c.resolve(!0)):d.deserializeReport({isLoadStateOnly:!0}).then(function(){a("#cl-customreport-container"+d.customReportId+" .rain").hide(),c.resolve(!0),d.showLimits()})}),c.promise},d.getInterColumnSortOrder=function(){var a=e.defer();if(d.report.visual&&0==d.report.interColumnSortOrder.length){var c=d.report.visual.model;c.getEffectiveProperties().then(function(e){var f=e.qHyperCubeDef.qDimensions.length,g=[],h=[];b.each(c.layout.qHyperCube.qEffectiveInterColumnSortOrder,function(a){if(h.push(a),a>=f){var c={dataId:e.qHyperCubeDef.qMeasures[a-f].dataId,type:"measure"};c.qSortBy=e.qHyperCubeDef.qMeasures[a-f].qSortBy,e.qHyperCubeDef.qMeasures[a-f].qDef.qReverseSort&&(c.qReverseSort=!0),g.push(c)}else if(a>=0){var c={dataId:e.qHyperCubeDef.qDimensions[a].dataId,type:"dimension"};e.qHyperCubeDef.qDimensions[a].qDef.qReverseSort&&(c.qReverseSort=!0),g.push(c)}else-1==a&&b.each(e.qHyperCubeDef.qMeasures,function(a){var b={dataId:a.dataId,type:"measure"};b.qSortBy=a.qSortBy,g.push(b)})}),d.report.NoOfLeftDims=e.qHyperCubeDef.qNoOfLeftDims,d.report.interColumnSortOrder=g,d.report.qInterColumnSortOrder=h,a.resolve(d.report)})}else{if(d.report.interColumnSortOrder.length!=d.report.usedDimensionsAndMeasures.length){var f=[],g=[];b.each(d.report.usedDimensionsAndMeasures,function(a,b){"pivot-table"===d.report.visualizationType&&"measure"===a.type?-1===f.indexOf(-1)&&f.push(-1):f.push(b),g.push({dataId:a.dataId,type:a.type})}),d.report.qInterColumnSortOrder=f,d.report.interColumnSortOrder=g}a.resolve(d.report)}return a.promise},d.setReportState=function(a,c,f){var g=e.defer(),h=c?e.resolve():d.prepareTable(f);return h.then(function(){a&&a.usedDimensionsAndMeasures&&b.each(a.usedDimensionsAndMeasures,function(a){var b=d.report.dimensions.map(function(a){return a.dataId}).indexOf(a.dataId);b>-1?d.report.dimensions[b].selected=!0:(b=d.report.measures.map(function(a){return a.dataId}).indexOf(a.dataId),b>-1&&(d.report.measures[b].selected=!0))}),g.resolve()}),g.promise},d.createChart=function(){d.createVisualization().then(function(){d.report.model&&d.updateUsedDimensionsMeasures(d.report.model.propertyTree.qProperty.qHyperCubeDef,d.report.visual.model.layout.qHyperCube),d.serializeReport()})},d.selectItem=function(a){var c=d.report.usedDimensionsAndMeasures.map(function(a){return a.dataId}).indexOf(a.dataId);if(c>-1){a.selected=!1,d.report.usedDimensionsAndMeasures.splice(c,1);var e=d.report.selections[a.type];e>0&&(d.report.selections[a.type]=e-1)}else{var f=d.data.activeTable,g=f&&b.find(d.layout.props.constraints,function(a){return a.object===f.qInfo.qId});if(g){var e=b.countBy(d.report.usedDimensionsAndMeasures,"type");if(g[a.type]>0&&e[a.type]>=g[a.type])return;d.report.selections[a.type]=(e[a.type]||0)+1}a.selected=!0,d.report.usedDimensionsAndMeasures.push(a)}d.isShouldCommitChanges=!0},d.commitChanges=function(){d.isShouldCommitChanges=!1,d.createChart()},d.clearAll=function(){b.each(d.report.dimensions,function(a){a.selected=!1}),b.each(d.report.measures,function(a){a.selected=!1}),d.report.usedDimensionsAndMeasures=[],d.report.interColumnSortOrder=[],d.report.qInterColumnSortOrder=[],d.report.currentState=null,d.showLimits(),d.createChart()},d.removeItem=function(a){if(d.report.usedDimensionsAndMeasures=b.without(d.report.usedDimensionsAndMeasures,a),"measure"==a.type){var c=d.report.measures.map(function(a){return a.dataId}).indexOf(a.dataId);c>=0&&c<d.report.measures.length&&(d.report.measures[c].selected=!1)}else{var c=d.report.dimensions.map(function(a){return a.dataId}).indexOf(a.dataId);c>=0&&c<d.report.dimensions.length&&(d.report.dimensions[c].selected=!1)}d.showLimits(),d.createChart()},d.hideFieldAndSortbar=function(){d.fieldsAndSortbarVisible=!1,d.createChart()},d.showFieldAndSortbar=function(){d.fieldsAndSortbarVisible=!0,d.createChart()},d.exportData=function(a){if(d.report.usedDimensionsAndMeasures.length>0){var b={};switch(a){case"exportToExcel":b={download:!0};break;case"exportAsCSV":b={format:"CSV_C",download:!0};break;case"exportAsCSVTab":b={format:"CSV_T",download:!0};break;case"exportToClipboard":b={download:!0}}d.report.visual&&m.visualization.get(d.report.visual.id).then(function(a){a.table.exportData(b)})}},d.storeSessionData=function(a){var b=n+"_"+a.activeTableId;sessionStorage.setItem(b,JSON.stringify(a))},d.restoreSessionData=function(a){var b=n+"_"+a;return sessionStorage.getItem(b)},d.serializeReportData=function(){if(!d.data.activeTable)return e.reject();var a=e.defer(),b=d.data.activeTable.qInfo.qId,c={activeTableId:b,fieldsAndSortbarVisible:d.fieldsAndSortbarVisible,states:{}};return c.states[b]={qId:b,visualizationType:d.data.activeTable.qData.visualization,usedDimensionsAndMeasures:d.report.usedDimensionsAndMeasures,layout:d.report.layout,qNoOfLeftDims:d.report.NoOfLeftDims},d.getInterColumnSortOrder().then(function(d){d&&(c.states[b].interColumnSortOrder=d.interColumnSortOrder,c.states[b].qInterColumnSortOrder=d.qInterColumnSortOrder),a.resolve(c)}),a.promise},d.serializeReport=function(){d.serializeReportData().then(function(a){d.storeSessionData(a);var b=JSON.stringify(a);if(d.report.currentState!=b){d.report.currentState=b;var c=d.layout.props.variable;c&&m.variable.getByName(c).then(function(a){a?a.setStringValue(b):m.variable.createSessionVariable({qInfo:{qType:"variable"},qMeta:{privileges:["read","update"]},qName:c,qDefinition:b,qIncludeInBookmark:!0})})["catch"](function(){m.variable.createSessionVariable({qInfo:{qType:"variable"},qMeta:{privileges:["read","update"]},qName:c,qDefinition:b,qIncludeInBookmark:!0})})}})},d.deserializeReport=function(a){var c=a&&a.isLoadStateOnly,f=a&&a.qId,g=f,h=e.defer(),i=d.layout.props.variableExp;if(g&&(i=d.restoreSessionData(f)),i)if(d.report.currentState!=i){var j,k={};try{j=JSON.parse(i)}catch(l){}if(j){var m=f||j.activeTableId;d.fieldsAndSortbarVisible=j.fieldsAndSortbarVisible,k=j.states&&j.states[m],k&&(d.report.visualizationType=k.visualizationType,isNaN(k.qNoOfLeftDims)||(d.report.NoOfLeftDims=k.qNoOfLeftDims),d.report.qInterColumnSortOrder=k.qInterColumnSortOrder?k.qInterColumnSortOrder:[],d.report.interColumnSortOrder=k.interColumnSortOrder?k.interColumnSortOrder:[],d.report.layout=k.layout,d.data.activeTable=b.find(d.data.masterObjectList,function(a){return a.qInfo.qId==m&&a.qData.visualization==d.report.visualizationType}))}d.report.usedDimensionsAndMeasures=k&&k.usedDimensionsAndMeasures||[],d.setReportState(k,c,!0).then(function(){!c||g?d.createChart():d.report.usedDimensionsAndMeasures.length>0&&d.serializeReport(),h.resolve()})}else h.resolve();else d.data.activeTable=f?b.find(d.data.masterObjectList,function(a){return a.qInfo.qId==f}):null,d.report.visualizationType=d.data.activeTable&&d.data.activeTable.qData.visualization||null,d.fieldsAndSortbarVisible=!0,d.report.interColumnSortOrder=[],d.report.qInterColumnSortOrder=[],d.report.usedDimensionsAndMeasures=[],d.report.currentState=null,d.report.NoOfLeftDims=null,d.report.layout=null,h.resolve();return h.promise},d.$on("$destroy",function(){d.serializeReport()}),d.$watchCollection("layout.props.tagSetting",function(a){d.data.tag=a,f()}),d.$watchCollection("layout.props.tagColor",function(a){d.data.tagColor=a}),d.$watchCollection("layout.props.collapseMinWidth",function(a){d.minWidthCollapsed=a}),d.$watchCollection("layout.props.collapseMinHeight",function(a){d.minHeightCollapsed=a}),d.$watchCollection("layout.props.displayText",function(a){d.data.displayText=a}),d.$watchCollection("layout.props.vizualizationsLabel",function(a){d.data.vizualizationsLabel=a,f().then(function(){d.report.currentState=null,d.deserializeReport()})}),d.$watchCollection("layout.props.dimensionsLabel",function(a){d.data.dimensionsLabel=a}),d.$watchCollection("layout.props.measuresLabel",function(a){d.data.measuresLabel=a}),d.$watchCollection("layout.props.dimensionSortOrder",function(a){d.data.sortOrder=a,d.loadActiveTable()}),d.getListMaxHeight=function(a){var b=38,c=d.report.dimensions.length,e=d.report.measures.length,f=140,g=(d.size.clientHeight-f)/2,h=b*c>g?0:g-b*c,i=b*e>g?0:g-b*e;return c>0?"dimension"==a?{"max-height":g+i+"px"}:{"max-height":g+h+"px"}:{height:g+"px"}},d.getTableHeight=function(){var b=70,c=a("#cl-customreport-container"+d.customReportId+" #reportSortable").height();return d.fieldsAndSortbarVisible?{height:d.size.clientHeight-b-c+"px","padding-top":"18px"}:{height:d.size.clientHeight+"px"}},d.getContainerWidth=function(a){var b=220,c={};return c="left"==a?b:d.fieldsAndSortbarVisible?d.size.clientWidth-b-20:d.size.clientWidth,{width:c+"px"}},g(),f().then(function(){var b=a("#cl-customreport-container"+d.customReportId+" #reportSortable")[0];k.create(b,d.reportConfig),d.deserializeReport().then(d.showLimits),a("#cl-customreport-container"+d.customReportId+" .rain").hide(),d.fieldsAndSortbarVisible||a("#cl-customreport-container"+d.customReportId).parents(".qv-inner-object").css("overflow","visible")})}]}});